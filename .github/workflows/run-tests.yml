name: CI Checks

# run this workflow on commits and pull requests
on: [push, pull_request]

jobs:
  tests:
    name: Test with Go ${{ matrix.go }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go:
          - 1.13.x
          - 1.14.x
          - 1.15.x
          - 1.16.x
          - 1.17.x
          - ^1.18  # Latest version of Go
    steps:
      - name: Use Go ${{ matrix.go }}
        uses: actions/setup-go@v3
        with:
          go-version: ${{ matrix.go }}

      - name: Checkout source
        uses: actions/checkout@master
        with:
          ref: ${{ github.ref }}

      - name: Install runner and dependencies
        run: |
          if [[ "$(go version)" =~ go1\.([0-9]+) ]] && (( "${BASH_REMATCH[1]}" >= 16 )); then
              go install github.com/alecaivazis/run@latest
          else
              go get github.com/alecaivazis/run
          fi
          export PATH=${PATH}:`go env GOPATH`/bin
          run install:ci

      - name: Run tests
        run: |
          export PATH=${PATH}:`go env GOPATH`/bin
          run tests:coverage

      - name: Report to Coveralls
        if: matrix.go == '^1.18'
        uses: shogo82148/actions-goveralls@v1
        with:
          path-to-profile: coverage.out
